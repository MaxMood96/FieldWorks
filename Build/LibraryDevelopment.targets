<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="Current">
	<Import Project="LibraryDevelopment.properties" Condition="Exists('LibraryDevelopment.properties')"/>
	<Target Name="UpdateDevelopmentPropertiesFile">
		<PropertyGroup>
			<!-- Upgrade legacy value -->
			<LcmArtifactsDir Condition="'$(LcmArtifactsDir)'=='' AND '$(LcmLocalArtifactsDir)'!=''">$(LcmLocalArtifactsDir)</LcmArtifactsDir>
			<LcmRootDir Condition="'$(LcmRootDir)'=='' AND '$(LcmLocalArtifactsDir)'!=''">$([System.IO.Path]::GetFullPath(&quot;$(LcmLocalArtifactsDir)/../..&quot;))</LcmRootDir>
			<!-- Fallback value -->
			<LcmRootDir Condition="'$(LcmRootDir)'==''">UNSPECIFIED</LcmRootDir>
		</PropertyGroup>
		<!-- Yellow text to catch the user's attention -->
		<Warning Text="To build localizations (and installers, which depend on them), github.com/sillsdev/liblcm must be cloned locally to '$(LcmRootDir)' (you can change this)"/>
		<MSBuild.ExtensionPack.UI.Console TaskAction="ReadLine" UserPrompt="Do you plan to build localizations? (y/N)" ToUpper="true"
			Condition="!Exists('LibraryDevelopment.properties')">
			<Output TaskParameter="UserResponse" PropertyName="NeedLocalLCM"/>
		</MSBuild.ExtensionPack.UI.Console>
		<MSBuild.ExtensionPack.UI.Console TaskAction="ReadLine" UserPrompt="What is the liblcm root path?" Condition="'$(NeedLocalLCM)'=='Y'">
			<Output TaskParameter="UserResponse" PropertyName="LcmRootDir"/>
		</MSBuild.ExtensionPack.UI.Console>
		<MSBuild Projects="$(MSBuildProjectFullPath)" Targets="WriteDevelopmentPropertiesFile" Properties="LcmRootDir=$(LcmRootDir);LcmArtifactsDir=$(LcmArtifactsDir)"/>
	</Target>
	<Target Name="WriteDevelopmentPropertiesFile">
		<!-- Using .temp file since it seemed xbuild was sometimes loading the .properties file while it was being composed. -->
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Overwrite="true" Lines="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;!-- This file is generated by the (Update|Write)DevelopmentPropertiesFile task, but it is safe to hand edit. --&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;Project xmlns=&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot; ToolsVersion=&quot;Current&quot;&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;PropertyGroup&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;UseLocalLibraries&gt;$(UseLocalLibraries)&lt;/UseLocalLibraries&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;PalasoArtifactsDir Condition=&quot;'%24(UseLocalLibraries)'=='Y'&quot;&gt;$(PalasoArtifactsDir)&lt;/PalasoArtifactsDir&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;ChorusArtifactsDir Condition=&quot;'%24(UseLocalLibraries)'=='Y'&quot;&gt;$(ChorusArtifactsDir)&lt;/ChorusArtifactsDir&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;!-- For localization, we always need to have access to the full LCM repository. --&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;LcmRootDir&gt;$(LcmRootDir)&lt;/LcmRootDir&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;LcmArtifactsDir Condition=&quot;'%24(UseLocalLibraries)'=='Y'&quot;&gt;$(LcmArtifactsDir)&lt;/LcmArtifactsDir&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;/PropertyGroup&gt;" />
		<WriteLinesToFile File="LibraryDevelopment.properties.temp" Lines="&lt;/Project&gt;" />
		<!-- Copy and Delete is easier than Move in mono4 xbuild. -->
		<Copy SourceFiles="LibraryDevelopment.properties.temp" DestinationFiles="LibraryDevelopment.properties" />
		<Delete Files="LibraryDevelopment.properties.temp" />
		</Target>

	<Target Name="WriteNonlocalDevelopmentPropertiesFile">
		<Message Text="Writing to LibraryDevelopment.properties, to not use local libraries."/>
		<CallTarget Targets="SetUseLocalLibrariesNo" />
		<CallTarget Targets="WriteDevelopmentPropertiesFile" />
	</Target>

	<Target Name="SetUseLocalLibrariesNo">
		<PropertyGroup>
			<UseLocalLibraries>N</UseLocalLibraries>
		</PropertyGroup>
	</Target>

	<Target Name="CheckDevelopmentPropertiesFile">
		<CallTarget Targets="UpdateDevelopmentPropertiesFile" Condition="'$(LcmRootDir)' == ''" />
	</Target>
</Project>